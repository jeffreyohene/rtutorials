---
title: "Regression"
output:
  learnr::tutorial:
    language: de
    css: css/boxes.css
    fig_caption: no
runtime: shiny_prerendered
bibliography: ref.json
link-citations: TRUE
description: Einführung in die einfache lineare Regression.
resource_files:
- css/boxes.css
---

```{r setup, include=FALSE}
library(learnr)
library(ggplot2)

knitr::opts_chunk$set(echo = FALSE)
```

## Inhalt

-   Vorannahmen der Regression prüfen

## Lernziele

## Überblick lineare Regression

### Ein Beispiel

Als Förster\*in in den USA stehst du vor einer Amerikanischen Traubenkirsche (*Prunus serotina*) ([wiki](https://de.wikipedia.org/wiki/Sp%C3%A4tbl%C3%BChende_Traubenkirsche)). Sie soll bald gefällt werden, denn sie hat ein begehrtes Holz, und du brauchst Geld. Am liebsten möchtest wissen, bevor du den Baum fällst, wie viele Kubikmeter Holz wohl dabei herauskommen werden, die du verkaufen kannst. Aber du möchtest keine allzu komplexen Messungen vornehmen. Den besten und einfachsten Schätzer, den wir bequem vornehmen können ist der Durchmesser des Baumes, der sich ungefähr aus dem Umfang errechnen lässt. Dafür braucht es lediglich ein Maßband und $\pi$.

Der Baum, vor dem wir stehen, hat einen Durchmesser von 45 cm. Wie viel Kubikmeter Holz können wir erwarten?

Wir haben bereits Daten von 31 gefällten Bäumen der gleichen Art, und können damit eine Vorhersage treffen. Die Daten befinden sich im `trees`-Datensatz, der in Base R eingebaut ist, und sind der Grund für dieses Beispiel.

### Beispieldaten

Schauen wir uns die Daten mal an:

:::{.aufgabe}
Wie sehen die ersten 6 Zeilen des Datensatzes `trees` aus?
:::

```{r head, exercise = TRUE}

```

```{r head-solution}
head(trees)
```

:::{.aufgabe}
Die Höhe `Height` lassen wir heute außen vor. 

Der Durchmesser heißt im Datensatz fälschlicherweise `Girth`, was Umfang bedeutet. (Das ist einfach ein Fehler in der Benennung, siehe `?trees`). 

Beheben Sie das, in dem Sie in `trees` eine neue Variable namens `Diameter` erstellen, die den Inhalt der Variable `Girth` enthält.
:::

```{r girth, exercise = TRUE}

```

```{r girth-solution}
trees$Diameter <- trees$Girth
```

:::{.aufgabe}
Die Variablen sind (typisch USA) alle in nicht-metrischen Einheiten angegeben. 

Rechnen Sie `Diameter` und `Girth` in metrische Einheiten um, damit das Beispiel intuitiver verständlich ist.

`Diameter` = Inch. Ziel: cm

`Volume` = ft³. Ziel: m³

**Hilfestellung zur Umrechung:**

$cm = Inch * 2.54$

$m^3 = ft^3 * 0.0283168466$

:::
```{r feet-setup}
trees$Diameter <- trees$Girth
```


```{r feet, exercise = TRUE}

```


```{r feet-solution}
trees$Diameter <- trees$Diameter * 2.54 # Inch in cm
trees$Volume <- trees$Volume * 0.0283168466 #  ft³ in m³

```

```{r silentsetup}
trees$Diameter <- trees$Girth * 2.54 # Inch in cm
trees$Volume <- trees$Volume * 0.0283168466 #  ft³ in m³
```


```{r, echo = TRUE}
ggplot(trees, aes(x = Diameter, y = Volume)) +
  geom_point() +
  theme_minimal() +
  labs(x = "Durchmesser (cm)", y = "Volumen (m³)")
```

Grundsätzlich sieht es so aus, dass wir mehr Holz ernten, je dicker der Baum war.

Durchmesser und Volumen hängen also irgendwie proportional zusammen. Für unsere Vorhersage wünschen wir uns aber zu wissen, wie genau diese Proportion aussieht.

Glücklicherweise sieht der Zusammenhang linear aus, das heißt, wir könnten ihn sinnvoll mit einer Gerade beschreiben:


```{r echo = TRUE}
ggplot(trees, aes(x = Diameter, y = Volume)) +
  geom_point() +
  geom_smooth(method = "lm", se = F) +
  theme_minimal() +
  labs(x = "Durchmesser (cm)", y = "Volumen (m³)")
```

Die blaue Gerade ist unser Modell, die Punkte sind die Realität, aus der wir das Modell abgeleitet haben. Ein Modell wird den Komplexitäten der Realität nie komplett gerecht, aber manche Modelle sind trotzdem sehr nützlich. Die Gerade hier zum Beispiel ist ein eher einfaches Modell und beschreibt die Realität trotzdem relativ gut. 

Geraden werden beschrieben durch lineare Funktionen. Unser Modell besteht also essentiell aus einer linearen Funktion! Wie genau das alles funktioniert, erfahrt ihr im nächsten Abschnitt. Vorher aber noch ein kleiner Test, ob ihr auch schon mit dem Modell umgehen könnt und die Eingangsfrage lösen könntet:

```{r first}
question_numeric(
  "Wie viel Kubikmeter Holz sind zu erwarten laut der blauen Gerade (unserem linearen Modell) bei einem Durchmesser von 45 cm?",
  answer(1.5, correct = T)
)
```

:::{.infobox}
Achtung! **Vereinfachungsalarm**

Wir lassen hier einige Dinge der Einfachheit halber komplett außer Acht, zum Beispiel:

- in der Forstwirtschaft wird zur Schätzung des Volumens eine etwas kompliziertere Formel verwendet, in die unter anderem die Höhe mit einfließt
- Dabei gibt es verschiedene Volumenmaße für Holz mit und ohne Rinde
- ...
:::

## lineare Funktionen

Die lineare Funktion kennen sicher alle noch aus der Schule, ca. 8. Klasse:

$$
\hat y = b_0 + b_1\cdot x_1
$$

oder in leicht abgewandelter Form:

$$
y = mx + n
$$

oder:

$$
y = a + bx
$$

Dabei steht $\hat y$ für den durch das Modell vorhergesagten Wert, auch engl. "*response variable"* genannt,"*output variable"* oder Kriterium. Im Beispiel wäre es das Holzvolumen in m³.

$x$ ist der Prädiktor, oder unser *input*, im Beispiel der Baumdurchmesser in Inches.

Daraus ergibt sich für uns folgendes Modell:

$$
\hat{Volumen} = b_0 + b_1 \cdot Durchmesser 
$$

::: infobox
Ein Dach über der Variable kennzeichnet immer, dass es sich hier um einen geschätzten Wert handelt.
:::

Aber was sind $b_0$ und $b_1$?

$b_0$ ist der vorhergesagte Wert, wenn $x$ 0 ist. Das ergibt sich aus der Gleichung:

$\hat y = b_0 + b_1 \cdot 0$

Bei einer Gerade ist $b_0$ also dort, wo $x = 0$. Das ist oft auch dort, wo die y-Achse verläuft, deswegen nennt man $b_0$ auch Achsenabschnitt oder *Intercept* auf Englisch.

$b_1$ ist die Änderung im vorhergesagten Wert ($\hat y$), wenn man $x$ um eine Einheit erhöht. 

Es erinnern sich bestimmt alle an das Dreieck, was man an die Gerade zeichnen kann. 

```{r}
.gerade <- function(x, intercept = 0, slope = 1){
  intercept + slope * x
}

ggplot() +
  stat_function(fun = `.gerade`, xlim = c(-1, 10), args = list(slope = -1.5, intercept = 9)) +
  geom_segment(aes(x = 2, y = 6, yend = 6, xend = 3), color = "red", 
               arrow = arrow(length = unit(0.03, "npc"))) +
  geom_segment(aes(x = 3, xend = 3, y = 6, yend = 4.5), color = "red",
               arrow = arrow(length = unit(0.03, "npc"))) +
  annotate("text", x = 2.5, y = 6.5, label = "1") +
  annotate("text", x = 3.5, y = 5.125, label = "-1.5") +
  coord_cartesian(xlim = c(0, 10), ylim = c(0, 10), expand = F) +
  scale_y_continuous(breaks = 0:10) +
  scale_x_continuous(breaks = 0:10) +
  theme_minimal()
```

Die zugehörige Geradengleichung lautet:

$\hat y = 9 - 1.5x$

mit Intercept $b_0 = 9$ und Steigung $b_1 = -1.5$

### Quiz

```{r}

ggplot() +
  stat_function(fun = `.gerade`, xlim = c(0, 20),
                args = list(intercept = 5, slope = 0.5)) +
  stat_function(fun = `.gerade`, xlim = c(0, 20),
                args = list(intercept = 10, slope = 1), linetype = "dashed") +
  coord_cartesian(ylim = c(0, 20), xlim = c(0, 20)) +
  theme_minimal()
```

```{r guess}
quiz(
  question_numeric(
  "Welche Steigung (b1) hat die gestrichelte Linie?",
  answer(1, correct = T)
  ),
  question_numeric(
  "Welche Steigung (b1) hat die durchgezogene Linie?",
  answer(0.5, correct = T)
  ),
  question_numeric(
    "Welches Intercept (b0) hat die gestrichelte Linie?",
    answer(10, correct = T)
  ),
  question_numeric(
    "Welches Intercept (b0) hat die durchgezogene Linie?",
    answer(5, correct = T)
  ),
  caption = "Schulmathe auffrischen"
)
```

### Fitting the model

Um die Modellparameter $b_0$ und $b_1$ zu bestimmen, brauchen wir zunächst Daten, anhand derer das Modell "trainiert" wird.

Die sind uns gegeben in Form des `trees`-Datensatzes, der in Base R eingebaut ist. Dafür wurden 31 Amerikanische Traubenkirschen (*Prunus serotina*) ([wiki](https://de.wikipedia.org/wiki/Sp%C3%A4tbl%C3%BChende_Traubenkirsche)) gefällt und Durchmesser und geerntetes Holzvolumen gemessen.

In einem schnellen Scatterplot können wir die Beziehung zwischen Durchmesser und Volumen visuell überprüfen.


```{r echo=TRUE}
plot(trees$Girth, trees$Volume)
```

::: infobox
Der Durchmesser heißt in den Daten fälschlicherweise `Girth`, bezieht sich aber nicht auf den Umfang sondern den Durchmesser. (siehe `?trees`)
:::

Die Modellparameter $b_0$ und $b_1$ werden so bestimmt, dass sie eine Gerade beschreiben, die möglichst nah an allen Punkten dran ist.

Mathematisch ausgedrückt: Die Regressionsgerade liegt so, dass die Summe der quadrierten Abweichungen minimal ist.

Wenn es fertig ist, sieht es so aus:

```{r echo=TRUE}
plot(trees$Girth, trees$Volume)
abline(lm(Volume ~ Girth, data = trees))
```


## Abschlussquiz

## Learnings
